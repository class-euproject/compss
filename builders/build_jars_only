#!/bin/bash -e

#####################################################################
# Name:         buildlocal
# Description:  Script for COMPSs local build
# Parameters:
#		[--monitor]     Enable Monitor installation
#		[--no-monitor]  Disable Monitor installation
#		[--bingings]    Enable bindings installation
#		[--no-bindings] Disable bindings installation
#		[--tracing]     Enable tracing system installation
#		[--no-tracing]  Disable tracing system installation
#		targetDir	COMPSs installation directory
######################################################################


#---------------------------------------------------
# SCRIPT CONSTANTS DECLARATION
#---------------------------------------------------
DEFAULT_MONITOR=true
DEFAULT_BINDINGS=true
DEFAULT_PYCOMPSS=true
DEFAULT_TRACING=true
DEFAULT_AUTOPARALLEL=true
DEFAULT_USER=false
DEFAULT_TARGET_DIR=/opt/COMPSs
DEFAULT_MVN_TESTS=""
MVN_SKIP_TESTS_OPT="-Dmaven.test.skip=true"

INCORRECT_PARAMETER="Error: No such parameter"
NO_MONITOR="Warning: No monitor specified. Loading default value"
NO_BINDINGS="Warning: No bindings specified. Loading default value"
NO_PYCOMPSS="Warning: No pycompss specified. Loading default value"
NO_TRACING="Warning: No tracing specified. Loading default value"
NO_AUTOPARALLEL="Warning: No autoparallel specified. Loading default value"
NO_TARGET_DIR="Warning: No install directory specified. Loading default location"


#---------------------------------------------------
# SET SCRIPT VARIABLES
#---------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SOURCES_DIR=${SCRIPT_DIR}/..
TMP_DIR=${SCRIPT_DIR}/tmp


#---------------------------------------------------
# FUNCTIONS DECLARATION
#---------------------------------------------------
show_opts() {
  cat <<EOT
* Options:
    --help, -h                  Print this help message

    --opts                      Show available options

    --version, -v               Print COMPSs version

    --monitor, -m               Enable Monitor installation
    --no-monitor, -M            Disable Monitor installation
                                Default: ${DEFAULT_MONITOR}

    --bindings, -b              Enable bindings installation
    --no-bindings, -B           Disable bindings installation
                                Default: ${DEFAULT_BINDINGS}

    --pycompss, -p              Enable PyCOMPSs installation
    --no-pycompss, -P           Disable PyCOMPSs installation
                                Default: ${DEFAULT_PYCOMPSS}

    --tracing, -t               Enable tracing system installation
    --no-tracing, -T            Disable tracing system installation
                                Default: ${DEFAULT_TRACING}

    --autoparallel, -a          Enable autoparallel module installation
    --no-autoparallel, -A       Disable autoparallel module installation
                                Default: ${DEFAULT_AUTOPARALLEL}
    
    --nothing, -N               Disable all previous options
                                Default: unused

    --user-exec=<str>           Enables a specific user execution for maven compilation
                                When used the maven install is not cleaned.
                                Default: ${DEFAULT_USER}

    --skip-tests                Disables MVN unit tests
                                Default: ${DEFAULT_MVN_TESTS}

* Parameters:
    targetDir                   COMPSs installation directory
                                Default: ${DEFAULT_TARGET_DIR}
                                            
EOT
}

usage() {
  exitValue=$1

  cat <<EOT
Usage: $0 [options] targetDir
EOT
  show_opts
  exit "$exitValue"
}

show_version() {
  echo "COMPSs version 2.4.rc1812"
  echo " "
}

# Displays arguments warnings
display_warning() {
  local warn_msg=$1
  echo "$warn_msg"
}

# Displays parsing arguments errors
display_error() {
  local error_msg=$1
  echo "$error_msg"

  echo " "
  usage 1
}


get_args() {
  # Parse COMPSs Options
  while getopts hvmMbBpPtTaAN-: flag; do 
    # Treat the argument
    case "$flag" in
      h)
	# Display help
	usage 0
	;;
      v)
        # Display version
        show_version
        exit
        ;;
      m)
        # Custom monitor value
        monitor=true
        ;;
      M)
        # Custom monitor value
        monitor=false
        ;;
      b)
        # Custom bindings value
        bindings=true
        pycompss=true
        ;;
      B)
        # Custom bindings value
        bindings=false
        pycompss=false
        ;;
      p)
        # Custom PyCOMPSs value
        pycompss=true
        ;;
      P)
        # Custom PyCOMPSs value
        pycompss=false
        ;;

      t)
        # Custom tracing value
        tracing=true
        ;;
      T)
        # Custom tracing value
        tracing=false
        ;;
      a)
        # Custom autoparallel value
        autoparallel=true
        ;;
      A)
        # Custom autoparallel value
        autoparallel=false
        ;;
      N)
        # Disables all flags
        tracing=false
        monitor=false
        bindings=false
        pycompss=false
        autoparallel=false
        ;;
      -)
	# Check more complex arguments
	case "$OPTARG" in
	  help)
	    # Display help
	    usage 0
	    ;;
          version)
            # Show version
            show_version
            exit 0
            ;;
          opts)
            # Display help
            show_opts
            exit 0
            ;;
          monitor)
            # Custom monitor value
            monitor=true
            ;;
          no-monitor)
            # Custom monitor value
            monitor=false
            ;;
          bindings)
            # Custom bindings value
            bindings=true
            pycompss=true
            ;;
          no-bindings)
            # Custom bindings value
            bindings=false
            pycompss=false
            ;;
          pycompss)
            # Custom PyCOMPSs value
            pycompss=true
            ;;
          no-pycompss)
            # Custom PyCOMPSs value
            pycompss=false
            ;;
          tracing)
            # Custom tracing value
            tracing=true
            ;;
          no-tracing)
            # Custom tracing value
            tracing=false
            ;;
          autoparallel)
            # Custom autoparallel value
            autoparallel=true
            ;;
          no-autoparallel)
            # Custom autoparallel value
            autoparallel=false
            ;;
          nothing)
            # Disables all flags
            tracing=false
            monitor=false
            bindings=false
            pycompss=false
            autoparallel=false
            ;;
          user-exec=*)
            # Enables specific user mvn execution
            user_exec=${OPTARG//user-exec=/}
            ;;
          skip-tests)
            # Disable mvn unit tests
            mvnTests=${MVN_SKIP_TESTS_OPT}
            ;;
          *)
          # Flag didn't match any patern. End of COMPSs flags
          display_error "${INCORRECT_PARAMETER}"
          break
          ;;
	esac
	;;
      *)
	# Flag didn't match any patern. End of COMPSs flags
	display_error "${INCORRECT_PARAMETER}"
	break
	;;
    esac
  done
  # Shift option arguments
  shift $((OPTIND-1))

  # Parse target directory location
  if [ $# -ne 0 ]; then
    targetDir=$1
  fi
}

check_args() {
  if [ -z "$monitor" ]; then
    display_warning "${NO_MONITOR}"
    monitor=${DEFAULT_MONITOR}
  fi

  if [ -z "$bindings" ]; then
    display_warning "${NO_BINDINGS}"
    bindings=${DEFAULT_BINDINGS}
  fi

  if [ -z "$pycompss" ]; then
    display_warning "${NO_PYCOMPSS}"
    pycompss=${DEFAULT_PYCOMPSS}
  fi

  if [ -z "$tracing" ]; then
    display_warning "${NO_TRACING}"
    tracing=${DEFAULT_TRACING}
  fi

  if [ -z "$autoparallel" ]; then
    display_warning "${NO_AUTOPARALLEL}"
    autoparallel=${DEFAULT_AUTOPARALLEL}
  fi

  if [ -z "${user_exec}" ]; then
    if [ -z "${SUDO_USER}" ]; then
      # Cannot retrieve sudo user from env
      user_exec=${DEFAULT_USER}
    else
      user_exec=${SUDO_USER}
    fi
  fi

  if [ -z "${mvnTests}" ]; then
    mvnTests=${DEFAULT_MVN_TESTS}
  fi

  if [ -z "$targetDir" ]; then
    display_warning "${NO_TARGET_DIR}"
    targetDir=${DEFAULT_TARGET_DIR}
  fi
}

warn_and_log_parameters() {
  # DISPLAY WARNING
  echo " WARNING: If you want to install COMPSs in a restricted folder"
  echo "          please run this script with root permissions"
  echo "    Example: sudo -E ./buildlocal [options] <targetDir>"
  echo "    !! Remember to export JAVA_HOME on root"
  sleep 5

  echo "- Target DIR   = ${targetDir}"
  echo "- Monitor      = ${monitor}"
  echo "- Bindings     = ${bindings}"
  echo "- PyCOMPSs     = ${pycompss}"
  echo "- Tracing      = ${tracing}"
  echo "- AutoParallel = ${autoparallel}"
  echo "- SCRIPT_DIR   = ${SCRIPT_DIR}"
  echo "- SOURCES DIR  = ${SOURCES_DIR}"
  echo "- TMP_DIR      = ${TMP_DIR}"
  sleep 5
}

install_compss() {
  # COMPILE
  echo "- Compile sources"
  cd "${SOURCES_DIR}/compss/"
  if [ "${user_exec}" == "${DEFAULT_USER}" ]; then
    echo "   (as root)"
    mvn -U clean package ${mvnTests}
  else
    echo "   (as user ${user_exec})"
    sudo -E -u "${user_exec}" mvn clean install ${mvnTests}
  fi
  cd "${SCRIPT_DIR}"

  # COPY TRUNK
  echo "- Copy trunk to tmpdir"
  rm -rf "${TMP_DIR}"
  mkdir -p "${TMP_DIR}"
  cp "${SOURCES_DIR}/changelog" "${TMP_DIR}"
  cp -r "${SOURCES_DIR}/compss" "${TMP_DIR}"
  cp -r "${SOURCES_DIR}/dependencies" "${TMP_DIR}"
  cp -r "${SOURCES_DIR}/doc" "${TMP_DIR}"
  cp -r "${SOURCES_DIR}/files" "${TMP_DIR}"
  cp -r "${SOURCES_DIR}/utils" "${TMP_DIR}"
  cp "${SOURCES_DIR}/LICENSE" "${TMP_DIR}"
  cp "${SOURCES_DIR}/NOTICE" "${TMP_DIR}"
  cp "${SOURCES_DIR}/pom.xml" "${TMP_DIR}"
  cp "${SOURCES_DIR}/README.md" "${TMP_DIR}"
  cp "${SOURCES_DIR}/RELEASE_NOTES" "${TMP_DIR}"
  find "${TMP_DIR}" -name ".git*" -print0 -exec rm -rf {} \; | cat # Clean git files

  # CLEAN TRUNK COMPILATION
  if [ "${user_exec}" == "${DEFAULT_USER}" ]; then
    echo "- Clean sources"
    cd "${SOURCES_DIR}/compss/"
    mvn -U clean
    cd "${SCRIPT_DIR}"
  fi

  # CREATE TARGET FOLDER
  echo "- Create target folder"
  # rm -rf ${targetDir}
  mkdir -p ${targetDir}
  mkdir -p ${targetDir}/Doc
  mkdir -p ${targetDir}/Dependencies
  mkdir -p ${targetDir}/Dependencies/extrae
  mkdir -p ${targetDir}/Runtime
  mkdir -p ${targetDir}/Runtime/configuration
  mkdir -p ${targetDir}/Runtime/scripts
  mkdir -p ${targetDir}/Runtime/adaptors
  mkdir -p ${targetDir}/Runtime/connectors
  mkdir -p ${targetDir}/Runtime/cloud-conn
  mkdir -p ${targetDir}/Runtime/scheduler
  mkdir -p ${targetDir}/Tools
  mkdir -p ${targetDir}/Tools/monitor
  mkdir -p ${targetDir}/Tools/storage
  mkdir -p ${targetDir}/Bindings
  mkdir -p ${targetDir}/Bindings/bindings-common

  # RUNTIME DEPLOYMENT
  echo "- Copy Runtime deployment files"
  # Doc
  echo "--- Copy docs"
  find "${TMP_DIR}/doc/" -name "*.html" -delete
  cp -r "${TMP_DIR}"/doc/* ${targetDir}/Doc
  cp "${TMP_DIR}/changelog" ${targetDir}
  cp "${TMP_DIR}/LICENSE" ${targetDir}
  cp "${TMP_DIR}/NOTICE" ${targetDir}
  cp "${TMP_DIR}/README.md" ${targetDir}
  cp "${TMP_DIR}/RELEASE_NOTES" ${targetDir}

  # DEPENDENCIES
  echo "--- Copy dependencies"
  # GAT
  cp -r "${TMP_DIR}/dependencies/JAVA_GAT" ${targetDir}/Dependencies/
  # Paraver CFGs
  cp -r "${TMP_DIR}/files/paraver" ${targetDir}/Dependencies/  

  # Config
  echo "--- Copy configuration"
  find "${TMP_DIR}"/compss/runtime/config -name src -type d -prune -exec rm -r "{}" \;
  find "${TMP_DIR}"/compss/runtime/config -name target -type d -prune -exec rm -r "{}" \;
  find "${TMP_DIR}"/compss/runtime/config -name pom.xml -delete
  cp -r "${TMP_DIR}"/compss/runtime/config/* ${targetDir}/Runtime/configuration/
  sed -i -e 's#/opt/COMPSs/#'${targetDir}'#g'  ${targetDir}/Runtime/configuration/xml/projects/default_project.xml

  # Scripts
  echo "--- Copy scripts"
  cp -r "${TMP_DIR}"/compss/runtime/scripts/* ${targetDir}/Runtime/scripts/

  # Adaptors
  echo "--- Copy adaptors"
  find "${TMP_DIR}/compss/runtime/adaptors" -name pom.xml -delete
  find "${TMP_DIR}/compss/runtime/adaptors" -name "*.iml" -delete
  rm -r "${TMP_DIR}/compss/runtime/adaptors/commons"
  rm -r "${TMP_DIR}/compss/runtime/adaptors/execution"
  path_source=${TMP_DIR}/compss/runtime/adaptors
  path_target=${targetDir}/Runtime/adaptors
  for adaptor in ${path_source}/*; do
    adaptor_name=$(basename "$adaptor")
    mkdir -p "${path_target}/${adaptor_name}"
    mkdir -p "${path_target}/${adaptor_name}"/master
    cp -f "$adaptor"/master/*.jar "${path_target}"/"${adaptor_name}"/master
    if [ -f "$adaptor"/master/properties ]; then
      cp "$adaptor"/master/properties "${path_target}"/"${adaptor_name}"/master
    fi
    if [ -d "$adaptor"/worker/ ]; then
      mkdir -p "${path_target}/${adaptor_name}"/worker
      cp -f "$adaptor"/worker/*.jar "${path_target}"/"${adaptor_name}"/worker
    fi
    if [ -f "$adaptor"/worker/properties ]; then 
      cp -f "$adaptor"/worker/properties "${path_target}"/"${adaptor_name}"/worker
    fi
    if [ -d "$adaptor"/scripts/ ]; then
      mkdir -p "${targetDir}"/Runtime/scripts/system/adaptors/"${adaptor_name}"
      cp -rf "$adaptor"/scripts/* "${targetDir}"/Runtime/scripts/system/adaptors/"${adaptor_name}"
    fi
  done

  # Schedulers
  echo "--- Copy schedulers"
  rm -r "${TMP_DIR}/compss/runtime/scheduler/commons"
  find "${TMP_DIR}/compss/runtime/scheduler/" -name "*.jar" -exec cp {} ${targetDir}/Runtime/scheduler/ \;

  # Storage
  echo "--- Copy storage implementations"

  echo "Dealing with Redis storage implementation..."
  cd "${TMP_DIR}/utils/storage/redisPSCO"
  ./make_bundle.sh
  cp -r COMPSs-Redis-bundle "${targetDir}/Tools/storage/redis"
  cd -

  # Connectors
  echo "--- Copy Runtime Connectors"
  connectors=$(find "${TMP_DIR}/compss/runtime/resources/" -name "*.jar" | grep -v "cloud-conn")
  for conn in $connectors; do
    cp "$conn" ${targetDir}/Runtime/connectors/
  done
  echo "--- Copy CONN Connectors"
  connectors=$(find "${TMP_DIR}/compss/runtime/resources/" -name "*.jar" | grep "cloud-conn")
  for conn in $connectors; do
    cp "$conn" ${targetDir}/Runtime/cloud-conn/
  done

  # Engine
  echo "--- Copy engine"
  cp "${TMP_DIR}/compss/runtime/compss-engine.jar" "${targetDir}/Runtime/"

}


#---------------------------------------------------
# MAIN EXECUTION
#---------------------------------------------------
  get_args "$@"
  check_args
  warn_and_log_parameters
  install_compss

  # END
  echo "Congratulations!"
  echo "COMPSs Runtime Successfully installed!"
  echo " "
  exit 0
